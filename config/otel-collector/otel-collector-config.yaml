receivers:
  # OTLP receiver - 接收 OpenTelemetry 数据
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317  # gRPC 端口
      http:
        endpoint: 0.0.0.0:4318  # HTTP 端口
        cors:
          allowed_origins:
            - "*"
          allowed_headers:
            - "*"
  
  # Jaeger receiver - 兼容 Jaeger 协议
  jaeger:
    protocols:
      grpc:
        endpoint: 0.0.0.0:14250
      thrift_http:
        endpoint: 0.0.0.0:14268
  
  # Zipkin receiver - 兼容 Zipkin 协议
  zipkin:
    endpoint: 0.0.0.0:9411

processors:
  # 批处理器 - 提高性能
  batch:
    timeout: 1s
    send_batch_size: 1024
    send_batch_max_size: 2048
  
  # 资源处理器 - 添加额外的资源属性
  resource:
    attributes:
      - key: environment
        value: "production"
        action: upsert
      - key: cluster
        value: "dev-cluster"
        action: upsert
  
  # 属性处理器 - 处理 span 属性
  attributes:
    actions:
      - key: http.user_agent
        action: delete
      - key: service.instance.id
        action: upsert
        from_attribute: host.name

exporters:
  # 使用 OTLP HTTP 发送日志到 Loki
  otlphttp:
    logs_endpoint: "http://loki:3100/loki/api/v1/push"
    headers:
      "Content-Type": "application/json"
  
  # 文件导出器 - 将日志写入文件，供 Promtail 收集
  file:
    path: "/tmp/otel-logs.json"
    rotation:
      max_megabytes: 100
      max_days: 3
  
  # 调试输出 - 用于排错
  debug:
    verbosity: basic

extensions:
  # 健康检查
  health_check:
    endpoint: 0.0.0.0:13133
  
  # pprof 性能分析
  pprof:
    endpoint: 0.0.0.0:1777
  
  # zpages 调试页面
  zpages:
    endpoint: 0.0.0.0:55679

service:
  extensions: [health_check, pprof, zpages]
  pipelines:
    # Traces pipeline
    traces:
      receivers: [otlp, jaeger, zipkin]
      processors: [resource, attributes, batch]
      exporters: [debug, file]
    
    # Logs pipeline  
    logs:
      receivers: [otlp]
      processors: [resource, batch]
      exporters: [debug, file]
    
    # Metrics pipeline (可选)
    metrics:
      receivers: [otlp]
      processors: [resource, batch]
      exporters: [debug]

  telemetry:
    logs:
      level: "info"
    metrics:
      level: detailed